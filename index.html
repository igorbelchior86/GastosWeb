
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Controle¬†365 ‚Äì Firebase (mobile‚Äëfriendly)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f2f4f7;--panel:#fff;--panel-alt:#f7f9fc;--accent:#007aff;--accent-hover:#0067d8;--danger:#d92d20;--text:#111827;--text-muted:#6b7280;--border:#d1d5db;--radius:8px;--shadow:0 3px 8px rgba(0,0,0,.05)}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif}
body{background:var(--bg);color:var(--text);padding:32px;display:flex;justify-content:center}
.wrapper{max-width:1100px;width:100%}
.container{background:var(--panel);border-radius:var(--radius);padding:24px;margin-bottom:24px;box-shadow:var(--shadow);border:1px solid var(--border)}
h2{font-size:1.5rem;font-weight:600;margin-bottom:16px}
/* form */
.form-grid{display:grid;grid-template-columns:2fr 1fr;grid-template-areas:"desc value" "method date" ". button";gap:12px;align-items:end}
.form-grid input,.form-grid select{border:1px solid var(--border);padding:12px 14px;border-radius:var(--radius);font-size:.9rem}
#desc{grid-area:desc;font-size:1rem;font-weight:500}
#value{grid-area:value}#method{grid-area:method}#opDate{grid-area:date}
#addBtn{grid-area:button;padding:12px 28px;border:none;border-radius:var(--radius);font-weight:600;background:var(--accent);color:#fff;cursor:pointer}
#addBtn:hover{background:var(--accent-hover)}
/* buttons etc */
button{padding:10px 20px;font-weight:600;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;cursor:pointer}
button:hover{background:var(--accent-hover)}button.danger{background:var(--danger)}button.danger:hover{opacity:.9}
/* table */
.table-wrapper{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-top:12px;min-width:640px}
thead th{background:var(--panel-alt);font-weight:600;font-size:.85rem;border-bottom:2px solid var(--border)}
th,td{padding:8px 10px;font-size:.83rem;border:1px solid var(--border);vertical-align:top}
td.negative{color:#b42318;font-weight:500}td.positive{color:#027a48;font-weight:500}td.saldo-neg{background:#fdeaea}
tr.month-header{background:var(--panel-alt);cursor:pointer}tr.month-header:hover{background:#e2e8f0}
details>summary{cursor:pointer;list-style:none;font-weight:500;margin-bottom:6px;display:flex;align-items:center;gap:6px}
details>summary::before{content:"‚ñ∏";transition:.2s}details[open]>summary::before{transform:rotate(90deg)}
.invoice{background:var(--panel-alt);padding:12px;border-radius:var(--radius);margin-bottom:8px}
.op-line{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.op-ts{font-size:.72rem;color:var(--text-muted);margin-left:22px}
button.icon{background:none;border:none;color:var(--text-muted);font-size:1rem;cursor:pointer;padding:0 2px}
button.icon:hover{color:var(--accent-hover)}button.icon.danger:hover{color:var(--danger)}
small{color:var(--text-muted);font-size:.78rem}
/* mobile tweaks */
@media(max-width:640px){
  body{padding:16px}
  .container{padding:16px}
  .form-grid{grid-template-columns:1fr;grid-template-areas:"desc""value""method""date""button"}
  #addBtn{width:100%}
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="container"><h2>Lan√ßar opera√ß√£o</h2>
    <div class="form-grid">
      <input id="desc" placeholder="Descri√ß√£o">
      <input id="value" type="number" placeholder="Valor (- para despesa)">
      <select id="method"></select>
      <input id="opDate" type="date">
      <button id="addBtn">Adicionar</button>
    </div>
  </div>

  <div class="container"><details><summary>Gerenciar cart√µes</summary>
    <div style="margin-top:16px">
      <fieldset style="display:flex;flex-wrap:wrap;gap:12px">
        <input id="cardName" placeholder="Nome cart√£o">
        <input id="cardClose" type="number" min="1" max="31" placeholder="Fechamento">
        <input id="cardDue" type="number" min="1" max="31" placeholder="Vencimento">
        <button id="addCardBtn">Adicionar cart√£o</button>
      </fieldset>
      <small>Compras at√© o fechamento entram na fatura do mesmo m√™s; ap√≥s, na seguinte.</small>
      <ul id="cardList" style="margin-top:12px"></ul>
    </div></details>
  </div>

  <div class="container">
    <div id="startGroup" style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <label for="startInput">Saldo inicial:</label>
      <input id="startInput" type="number" style="flex:0 0 120px">
      <button id="setStartBtn">OK</button>
    </div>

    <div class="table-wrapper">
      <table id="dailyTable"><thead><tr><th style="width:90px">Data</th><th>Descri√ß√£o</th><th style="width:110px">Gastos dia</th><th style="width:110px">Saldo</th></tr></thead><tbody></tbody></table>
    </div>

    <button id="resetData" class="danger" style="margin-top:16px">Limpar TODOS os dados</button>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyATGZtBlnSPnFtVgTqJ_E0xmBgzLTmMkI0",
  authDomain: "gastosweb-e7356.firebaseapp.com",
  databaseURL: "https://gastosweb-e7356-default-rtdb.firebaseio.com",
  projectId: "gastosweb-e7356",
  storageBucket: "gastosweb-e7356.firebasestorage.app",
  messagingSenderId: "519966772782",
  appId: "1:519966772782:web:9ec19e944e23dbe9e899bf"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const PATH = 'orcamento365_9b8e04c5';

const save=(k,v)=>set(ref(db,`${PATH}/${k}`),v);
const load=async(k,d)=>{const s=await get(ref(db,`${PATH}/${k}`));return s.exists()?s.val():d;};

let transactions=[],cards=[],startBalance=null;

/* elements */
const $=id=>document.getElementById(id);
const descEl=$('desc'),valueEl=$('value'),methodEl=$('method'),dateEl=$('opDate'),addBtn=$('addBtn');
const cardNameEl=$('cardName'),cardCloseEl=$('cardClose'),cardDueEl=$('cardDue'),addCardBtn=$('addCardBtn'),cardListEl=$('cardList');
const startGroup=$('startGroup'),startInput=$('startInput'),setStartBtn=$('setStartBtn'),resetBtn=$('resetData');
const tbody=document.querySelector('#dailyTable tbody');

/* utils */
const currency=v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const meses=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const fmtTS=ts=>new Date(ts).toLocaleDateString('pt-BR')+' '+new Date(ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
const postDate=(date,method)=>{
  if(method==='dinheiro')return date;
  const c=cards.find(x=>x.name===method);if(!c)return date;
  const [y,m,d]=date.split('-').map(Number);let mm=m,yy=y;if(d>c.close){mm++;if(mm===13){mm=1;yy++;}}
  return yy+'-'+String(mm).padStart(2,'0')+'-'+String(c.due).padStart(2,'0');
};

/* UI helpers */
function refreshMethods(){methodEl.innerHTML='';cards.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=c.name;methodEl.appendChild(o);});}
function renderCardList(){
  cardListEl.innerHTML='';cards.filter(c=>c.name!=='dinheiro').forEach(c=>{
    const li=document.createElement('li');li.textContent=`${c.name} (fech ${c.close}/venc ${c.due})`;
    const del=document.createElement('button');del.className='icon danger';del.textContent='üóë';del.onclick=()=>{if(confirm('Excluir cart√£o?')){cards=cards.filter(x=>x.name!==c.name);save('cards',cards);refreshMethods();renderCardList();renderTable();}};
    li.appendChild(del);cardListEl.appendChild(li);
  });
}
const lineElem=t=>{const d=document.createElement('div');d.className='op-line';d.innerHTML=`${t.desc} <span class="value">${currency(t.val)}</span>`;
  const e=document.createElement('button');e.className='icon';e.textContent='‚úèÔ∏è';e.onclick=()=>editTx(t.id);
  const del=document.createElement('button');del.className='icon danger';del.textContent='üóë';del.onclick=()=>delTx(t.id);
  d.appendChild(e);d.appendChild(del);return d;};

/* crud */
function addCard(){const n=cardNameEl.value.trim(),close=+cardCloseEl.value,due=+cardDueEl.value;
  if(!n||close<1||close>31||due<1||due>31||close>=due||cards.some(c=>c.name===n)){alert('Dados inv√°lidos');return;}
  cards.push({name:n,close,due});save('cards',cards);refreshMethods();renderCardList();
  cardNameEl.value='';cardCloseEl.value='';cardDueEl.value='';
}
function addTx(){
  const d=descEl.value.trim(),v=parseFloat(valueEl.value),m=methodEl.value,date=dateEl.value;
  if(!d||isNaN(v)||!date){alert('Campos incompletos');return;}
  transactions.push({id:Date.now(),desc:d,val:v,method:m,opDate:date,postDate:postDate(date,m),ts:new Date().toISOString()});
  save('tx',transactions);descEl.value='';valueEl.value='';dateEl.value=new Date().toISOString().slice(0,10);renderTable();
}
const delTx=id=>{if(!confirm('Apagar?'))return;transactions=transactions.filter(t=>t.id!==id);save('tx',transactions);renderTable();};
const editTx=id=>{const t=transactions.find(x=>x.id===id);if(!t)return;const nd=prompt('Descri√ß√£o',t.desc);if(nd===null)return;const nv=parseFloat(prompt('Valor',t.val));if(isNaN(nv))return;t.desc=nd.trim();t.val=nv;save('tx',transactions);renderTable();};

/* table */
function renderTable(){
  tbody.innerHTML='';const year=new Date().getFullYear();let saldo=startBalance||0;
  for(let m=0;m<12;m++){
    const head=document.createElement('tr');head.className='month-header';head.dataset.m=m;
    const cell=document.createElement('td');cell.colSpan=4;cell.textContent=meses[m];head.appendChild(cell);
    head.onclick=()=>{const closed=head.classList.toggle('closed');document.querySelectorAll(`tr[data-month='${m}']`).forEach(r=>r.style.display=closed?'none':'table-row');};
    tbody.appendChild(head);
    for(let d=1;d<=31;d++){
      const date=new Date(year,m,d);if(date.getMonth()!==m)break;
      const iso=date.toISOString().slice(0,10);const dayTx=transactions.filter(t=>t.postDate===iso);
      const sum=dayTx.reduce((s,t)=>s+t.val,0);saldo+=sum;
      const tr=document.createElement('tr');tr.dataset.month=m;
      tr.innerHTML=`<td>${date.toLocaleDateString('pt-BR')}</td><td></td><td></td><td>${currency(saldo)}</td>`;
      const tdDesc=tr.children[1],tdSum=tr.children[2],tdSaldo=tr.children[3];
      if(saldo<0)tdSaldo.className='saldo-neg';
      if(sum!==0){tdSum.textContent=currency(sum);tdSum.className=sum<0?'negative':'positive';}
      dayTx.filter(t=>t.method==='dinheiro').forEach(t=>tdDesc.appendChild(lineElem(t)));
      const groups={};dayTx.filter(t=>t.method!=='dinheiro').forEach(t=>(groups[t.method]=groups[t.method]||[]).push(t));
      Object.keys(groups).forEach(card=>{
        const det=document.createElement('details');det.className='invoice';
        const sum=document.createElement('summary');sum.textContent='Fatura '+card;det.appendChild(sum);
        groups[card].forEach(t=>{det.appendChild(lineElem(t));const ts=document.createElement('div');ts.className='op-ts';ts.textContent=fmtTS(t.ts);det.appendChild(ts);});
        tdDesc.appendChild(det);
      });
      tbody.appendChild(tr);
    }
  }
}

function initStartUI(){startGroup.style.display=startBalance===null?'flex':'none';}

setStartBtn.onclick=()=>{const v=parseFloat(startInput.value);if(isNaN(v)){alert('Valor inv√°lido');return;}startBalance=v;save('startBal',startBalance);initStartUI();renderTable();};
resetBtn.onclick=()=>{
  if(!confirm('Apagar tudo?'))return;
  transactions=[];cards=[{name:'dinheiro',close:0,due:0}];startBalance=null;
  save('tx',transactions);save('cards',cards);save('startBal',null);
  refreshMethods();renderCardList();initStartUI();renderTable();
};

addCardBtn.onclick=addCard;
addBtn.onclick=addTx;

/* initial load */
(async()=>{
  transactions=await load('tx',[]);
  cards=await load('cards',[{name:'dinheiro',close:0,due:0}]);
  startBalance=await load('startBal',null);
  refreshMethods();renderCardList();initStartUI();
  dateEl.value=new Date().toISOString().slice(0,10);
  renderTable();
})();
</script>
</body>
</html>
